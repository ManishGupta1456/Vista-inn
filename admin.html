<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin â€“ Block Room Dates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem auto;
      padding: 1rem;
      max-width: 1200px;
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      justify-content: space-between;
    }
    .form-section, .calendar-section {
      flex: 1 1 45%;
      min-width: 320px;
    }
    label {
      display: block;
      margin-bottom: 1rem;
    }
    input, select {
      padding: 0.5rem;
      width: 100%;
      margin-top: 0.5rem;
    }
    button {
      padding: 0.6rem 1.5rem;
      background: #2e3b4e;
      color: white;
      border: none;
      cursor: pointer;
    }
    #status {
      margin-top: 1rem;
    }
    #calendar {
      margin-top: 1rem;
    }
  </style>
</head>
<body>
 
  <div class="form-section">
    <h2>Block Room Date</h2>
    <form id="block-form">
      <label>
        Room Type:
        <select name="room_type" id="room_type" required>
          <option value="double">Deluxe Double</option>
          <option value="single">Deluxe Single</option>
        </select>
      </label>

      <label>
  Start Date:
  <input type="date" name="start_date" required>
</label>

<label>
  End Date:
  <input type="date" name="end_date" required>
</label>


      <label>
        Reason:
        <input type="text" name="reason" placeholder="e.g. Offline Booking or Maintenance">
      </label>

      <button type="submit">Block Date</button>
    </form>

    <p id="status"></p>
  </div>

  <div class="calendar-section">
    <h2>ðŸ“… Room Status Calendar</h2>
    <p>
      View Room Type:
      <select id="calendar-roomtype">
        <option value="double">Deluxe Double</option>
        <option value="single">Deluxe Single</option>
      </select>
    </p>
    <div id="calendar"></div>
  </div>

  <!-- FullCalendar and Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase;
    const supabaseClient = createClient(
      'https://fvfhptpkyntqijtpgdse.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2ZmhwdHBreW50cWlqdHBnZHNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNDk4OTAsImV4cCI6MjA2NjkyNTg5MH0.HFVj4oZ_acMOmLiL7ix-G8DahuWzmL9mqDkuvjr8HRA'
    );

    const maxRooms = { double: 3, single: 1 };
    const form = document.getElementById('block-form');
    const status = document.getElementById("status");
    const calendarEl = document.getElementById('calendar');
    const roomTypeSelect = document.getElementById('room_type');
    const calendarRoomTypeSelect = document.getElementById('calendar-roomtype');
    let calendar;

    async function loadCalendar(roomType) {
      const bookingsResponse = await supabaseClient
        .from('bookings')
        .select('checkin_date, checkout_date')
        .eq('room_type', roomType);

      const blocksResponse = await supabaseClient
        .from('blocked_dates')
        .select('start_date, end_date, reason')
        .eq('room_type', roomType);

      const bookings = bookingsResponse.data || [];
      const blocks = blocksResponse.data || [];

      const eventMap = {};

      bookings.forEach(b => {
        const start = new Date(b.checkin_date);
        const end = new Date(b.checkout_date);
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          const key = new Date(d).toISOString().split("T")[0];
          if (!eventMap[key]) eventMap[key] = { booked: 0, blocked: null };
          eventMap[key].booked += 1;
        }
      });

      blocks.forEach(b => {
        const start = new Date(b.start_date);
        const end = new Date(b.end_date || b.start_date);
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          const key = new Date(d).toISOString().split("T")[0];
          if (!eventMap[key]) eventMap[key] = { booked: 0, blocked: null };
          eventMap[key].blocked = b.reason || "Blocked";
        }
      });

      const events = [];
      for (const date in eventMap) {
        const { booked, blocked } = eventMap[date];
        if (blocked) {
          events.push({
            title: `ðŸ”’ ${blocked}`,
            start: date,
            allDay: true,
            color: "#f8d7da"
          });
        } else if (booked >= maxRooms[roomType]) {
          events.push({
            title: `ðŸŸ  Fully Booked (${booked})`,
            start: date,
            allDay: true,
            color: "#ffeeba"
          });
        } else if (booked > 0) {
          events.push({
            title: `ðŸŸ¢ ${booked}/${maxRooms[roomType]} Booked`,
            start: date,
            allDay: true,
            color: "#d4edda"
          });
        }
      }

      if (calendar) {
        calendar.removeAllEvents();
        calendar.addEventSource(events);
      } else {
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          events: events,
          height: "auto"
        });
        calendar.render();
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const room_type = form.room_type.value;
      const start_date = form.start_date.value;
const end_date = form.end_date.value;

      const reason = form.reason.value;
      const { error } = await supabaseClient.from('blocked_dates').insert([
        { room_type, start_date, end_date, reason }

      ]);
      const status = document.getElementById("status");
      if (error) {
        console.error(error);
        status.textContent = "âŒ Failed to block date.";
      } else {
        status.textContent = "âœ… Date successfully blocked.";
        form.reset();
        loadCalendar(room_type); // refresh calendar
      }
    });

    roomTypeSelect.addEventListener('change', () => {
      loadCalendar(roomTypeSelect.value);
    });

    document.addEventListener('DOMContentLoaded', () => {
      loadCalendar(roomTypeSelect.value);
    });


  </script>
</body>
</html>
