<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Book Your Stay ‚Äì Vista Inn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Book Your Stay</h1>
    <nav>
      <a href="index.html">Home</a>
    </nav>
  </header>

  <main class="booking-form">
    <h2>Reservation Details</h2>
    <form>
      <label>Full Name:
        <input type="text" name="name" required>
      </label>
      <label>Email:
        <input type="email" name="email" required>
      </label>
      <label>Phone:
        <input type="tel" name="phone" required>
      </label>
      <label>Check-in Date:
        <input type="date" name="checkin" required>
      </label>
      <label>Check-out Date:
        <input type="date" name="checkout" required>
      </label>
      <label>Number of Guests:
        <input type="number" name="guests" min="1" max="2" required>
      </label>
      <label>Room Type:
        <select name="roomtype" required>
          <option value="double">Deluxe Double Room</option>
          <option value="single">Deluxe Single Room</option>
        </select>
      </label>
      <button type="submit">Confirm Booking</button>
    </form>
  </main>

  <footer>
    <p>¬© 2025 Vista Inn. All rights reserved.</p>
  </footer>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase;
    const supabaseClient = createClient(
      'https://fvfhptpkyntqijtpgdse.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2ZmhwdHBreW50cWlqdHBnZHNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNDk4OTAsImV4cCI6MjA2NjkyNTg5MH0.HFVj4oZ_acMOmLiL7ix-G8DahuWzmL9mqDkuvjr8HRA'
    );

window.addEventListener('DOMContentLoaded', () => {
  const roomTypeSelect = document.getElementById('roomtype');
  const guestsInput = document.getElementById('guests');

  if (roomTypeSelect && guestsInput) {
    roomTypeSelect.addEventListener('change', () => {
      if (roomTypeSelect.value === 'single') {
        guestsInput.max = 1;
        guestsInput.value = 1;
      } else {
        guestsInput.max = 2;
        if (guestsInput.value < 1) guestsInput.value = 1;
      }
    });

    // üëá Also run once on load to set correct guest limit
    roomTypeSelect.dispatchEvent(new Event('change'));
  }
});
    function getDateRange(start, end) {
      const dates = [];
      let current = new Date(start);
      const last = new Date(end);
      while (current <= last) {
        dates.push(current.toISOString().split("T")[0]);
        current.setDate(current.getDate() + 1);
      }
      return dates;
    }

    const form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
  const room_type = form.roomtype.value;
  const guests = parseInt(form.guests.value);

  // üîí Enforce guest limits manually
  if ((room_type === 'single' && guests > 1) || (room_type === 'double' && guests > 2)) {
    alert(`‚ùå Guest limit exceeded for ${room_type} room.`);
    return;
  }

        
        const checkin = form.checkin.value;
        const checkout = form.checkout.value;
        const name = form.name.value;
        const email = form.email.value;
	const phone = form.phone.value;
        const maxRooms = room_type === 'double' ? 3 : 1;

        const datesToCheck = getDateRange(checkin, checkout);

        for (const date of datesToCheck) {
          try {
            // Get all bookings of this type
            const resultBookings = await supabaseClient
              .from('bookings')
              .select('checkin_date, checkout_date')
              .eq('room_type', room_type);

            const bookings = (resultBookings.data || []).filter(b => {
  const inDate = new Date(date);
  const start = new Date(b.checkin_date);
  const end = new Date(b.checkout_date);
  return inDate >= start && inDate <= end;
});

            const resultBlocked = await supabaseClient
  .from('blocked_dates')
  .select('start_date, end_date')
  .eq('room_type', room_type);

const blocked = (resultBlocked.data || []).filter(b => {
  const inDate = new Date(date);
  const start = new Date(b.start_date);
  const end = new Date(b.end_date);
  return inDate >= start && inDate <= end;
});

const bookedCount = bookings.length + blocked.length;
console.log(`üìÜ ${date} ‚Üí Booked: ${bookings.length}, Blocked: ${blocked.length}`);

if (bookedCount >= maxRooms) {
  alert(`‚ùå No rooms available on ${date}. Please choose other dates.`);
  return;
}

          } catch (err) {
            console.error("‚ö† Error checking availability:", err);
            alert("Something went wrong while checking availability.");
            return;
          }
        }

        // Save the booking
        const { error } = await supabaseClient.from('bookings').insert([{
          room_type,
          checkin_date: checkin,
          checkout_date: checkout,
          guest_name: name,
          guest_email: email,
	  guest_phone: phone
        }]);

        if (error) {
          console.error(error);
          alert("‚ùå Booking failed.");
        } else {
          alert("‚úÖ Booking confirmed!");
          window.location.href = "index.html";
        }
if (!error) {
  // Call backend to send email
  fetch("https://vistainn.netlify.app/.netlify/functions/send-email", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      name,
      email,
      phone,
      room_type,
      checkin,
      checkout
    })
  })
  .then(res => res.json())
  .then(() => {
    alert("‚úÖ Booking confirmed! Confirmation email sent.");
    window.location.href = "index.html";
  })
  .catch(err => {
    console.error("‚ùå Function failed:", err); // shows full error in console
  alert("‚ùå Email function error: " + err.message);
    window.location.href = "index.html";
  });
}

      });
    }
  </script>
</body>
</html>
