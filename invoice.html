<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hotel Vista Inn - Invoice Generator</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.7/build/pdfmake.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.7/build/vfs_fonts.js"></script>
</head>
<body>

<div id="invoice-app" class="invoice-card">
  <h2 class="hotel-header">Hotel Vista Inn - Invoice Generator</h2>

  <label>Booking ID:</label>
  <input type="text" id="booking-id">
  <button onclick="fetchBooking()">Fetch Booking</button>

  <label>Guest Name:</label>
  <input type="text" id="guest-name">

  <label>Guest GSTIN:</label>
  <input type="text" id="guest-gstin">

  <label>Guest Email:</label>
  <input type="email" id="guest-email">

  <label>Room Type:</label>
  <input type="text" id="room-type">

  <label>Check-in Date:</label>
  <input type="date" id="checkin-date" onchange="updateTotalNights()">

  <label>Check-out Date:</label>
  <input type="date" id="checkout-date" onchange="updateTotalNights()">

  <label>Total Nights:</label>
  <input type="number" id="total-nights" readonly>

  <label>Room Tariff/Night (₹):</label>
  <input type="number" id="room-tariff" step="0.01" onchange="updateTaxableValue()">

  <label>Discount (₹):</label>
  <input type="number" id="discount" step="0.01" value="0" onchange="updateTaxableValue()">

  <label>Taxable Value (₹):</label>
  <input type="number" id="taxable-value" readonly>

  <button id="generate-btn" onclick="generateInvoice()">Generate Invoice</button>
</div>

<script>
// Supabase connection
const supabaseClient = supabase.createClient(
  "YOUR_SUPABASE_URL",
  "YOUR_SUPABASE_ANON_KEY"
);

// GST calculation – matching DB column names
function calculateGST(amount) {
  const cgst = amount * 0.06;
  const sgst = amount * 0.06;
  const total_gst = cgst + sgst;
  const total_invoice_value = amount + total_gst;
  return {
    cgst: +cgst.toFixed(2),
    sgst: +sgst.toFixed(2),
    total_gst: +total_gst.toFixed(2),
    total_invoice_value: +total_invoice_value.toFixed(2)
  };
}

// Calculate nights
function updateTotalNights() {
  const ci = document.getElementById("checkin-date").value;
  const co = document.getElementById("checkout-date").value;
  let nights = 0;
  if (ci && co) {
    nights = Math.max(0, Math.ceil((new Date(co) - new Date(ci)) / (1000*60*60*24)));
  }
  document.getElementById("total-nights").value = nights;
  updateTaxableValue();
}

// Calculate taxable value
function updateTaxableValue() {
  const nights = +document.getElementById("total-nights").value || 0;
  const tariff = +document.getElementById("room-tariff").value || 0;
  const discount = +document.getElementById("discount").value || 0;
  let value = (tariff * nights) - discount;
  if (value < 0) value = 0;
  document.getElementById("taxable-value").value = value.toFixed(2);
}

// Fetch booking
async function fetchBooking() {
  const bid = document.getElementById("booking-id").value.trim();
  if (!bid) return alert("Enter Booking ID");

  const { data, error } = await supabaseClient
    .from("bookings")
    .select("*")
    .eq("booking_id", bid)
    .single();

  if (error || !data) {
    alert("Booking not found. Please fill manually.");
    return;
  }

  document.getElementById("guest-name").value = data.guest_name || "";
  document.getElementById("guest-email").value = data.guest_email || "";
  document.getElementById("room-type").value = data.room_type || "";
  document.getElementById("checkin-date").value = data.checkin_date || "";
  document.getElementById("checkout-date").value = data.checkout_date || "";
  document.getElementById("room-tariff").value = data.room_tariff || "";
  document.getElementById("discount").value = data.discount || 0;

  updateTotalNights();
}

// Get invoice by booking
async function getInvoiceByBookingId(bookingId) {
  const { data, error } = await supabaseClient
    .from("invoices")
    .select("*")
    .eq("booking_id", bookingId)
    .single();
  return { data, error };
}

// Generate invoice
async function generateInvoice() {
  const bookingId = document.getElementById("booking-id").value.trim();
  if (!bookingId) {
    alert("Booking ID required");
    return;
  }

  document.getElementById("generate-btn").disabled = true;

  // Step 1: Check existing
  const { data: existing } = await getInvoiceByBookingId(bookingId);
  if (existing) {
    generateInvoicePDF(existing);
    document.getElementById("generate-btn").disabled = false;
    return;
  }

  // Step 2: Prepare data
  const taxableValue = +document.getElementById("taxable-value").value || 0;
  const gstData = calculateGST(taxableValue);

  const inv = {
    booking_id: bookingId,
    invoice_date: new Date().toISOString(),
    guest_name: document.getElementById("guest-name").value,
    guest_gstin: document.getElementById("guest-gstin").value || null,
    guest_email: document.getElementById("guest-email").value || null,
    room_type: document.getElementById("room-type").value,
    checkin_date: document.getElementById("checkin-date").value,
    checkout_date: document.getElementById("checkout-date").value,
    total_night: +document.getElementById("total-nights").value || 0,
    room_tariff: +document.getElementById("room-tariff").value || 0,
    discount: +document.getElementById("discount").value || 0,
    taxable_value: taxableValue,
    cgst: gstData.cgst,
    sgst: gstData.sgst,
    total_gst: gstData.total_gst,
    total_invoice_value: gstData.total_invoice_value,
    supply_state: "Rajasthan",
    is_b2b: !!document.getElementById("guest-gstin").value
  };

  // Step 3: Insert
  const { data: inserted, error: insertError } = await supabaseClient
    .from("invoices")
    .insert([inv])
    .select();

  if (insertError || !inserted || !inserted[0] || !inserted[0].serial_id) {
    alert("Failed to save invoice: " + (insertError?.message || ""));
    document.getElementById("generate-btn").disabled = false;
    return;
  }

  const serialId = inserted[0].serial_id;
  const invoiceNumber = "INV-" + String(serialId).padStart(4, "0");

  // Step 4: Update invoice_number if null
  const { error: updateError } = await supabaseClient
    .from("invoices")
    .update({ invoice_number: invoiceNumber })
    .eq("serial_id", serialId)
    .is("invoice_number", null);

  if (updateError) {
    alert("Failed to update invoice number: " + updateError.message);
    document.getElementById("generate-btn").disabled = false;
    return;
  }

  // Step 5: Fetch final row
  const { data: finalInvoice } = await supabaseClient
    .from("invoices")
    .select("*")
    .eq("serial_id", serialId)
    .single();

  if (!finalInvoice) {
    alert("Could not fetch final invoice data.");
    document.getElementById("generate-btn").disabled = false;
    return;
  }

  generateInvoicePDF(finalInvoice);
  document.getElementById("generate-btn").disabled = false;
}

// PDF generator (adjust colors/layout to taste)
function generateInvoicePDF(inv) {
  const hotel = {
    name: "Hotel Vista Inn",
    address: "9A, Ranthambore road, Shooting Laudge Road,\nNear Big Cat, Patel Nagar, Sawai Madhopur, Rajasthan, 322001",
    phone: "+91 9571719570",
    email: "vista.ranthambore@gmail.com",
    gstin: "08CLCPD8632E1ZB"
  };

  const dd = {
    content: [
      { text: hotel.name, style: "hotelName", alignment: "center" },
      { text: hotel.address, alignment: "center" },
      { text: `Email: ${hotel.email} | Phone: ${hotel.phone}`, alignment: "center" },
      { text: `GST No.: ${hotel.gstin}`, alignment: "center", margin: [0, 0, 0, 10] },
      { text: "INVOICE", style: "header", alignment: "center", margin: [0, 10] },
      {
        table: {
          widths: ["auto", "*", "auto", "*"],
          body: [
            ["Billing To:", inv.guest_name || "", "Invoice No.:", inv.invoice_number],
            ["Booking ID:", inv.booking_id, "Date:", new Date(inv.invoice_date).toLocaleDateString()],
            ["GSTIN:", inv.guest_gstin || "", "Room Type:", inv.room_type || ""],
            ["Email:", inv.guest_email || "", "Check In:", inv.checkin_date || ""],
            ["", "", "Check Out:", inv.checkout_date || ""]
          ]
        },
        layout: "noBorders"
      },
      {
        table: {
          widths: ["*", "auto", "auto", "auto", "auto"],
          body: [
            ["Description", "Total Night", "Room Tariff/Night", "Discount", "Amount"],
            ["Room Charges", inv.total_night, inv.room_tariff.toFixed(2), inv.discount.toFixed(2), inv.taxable_value.toFixed(2)]
          ]
        },
        margin: [0, 10]
      },
      {
        table: {
          widths: ["*", "auto"],
          body: [
            ["Sub Total", inv.taxable_value.toFixed(2)],
            ["CGST @ 6%", inv.cgst.toFixed(2)],
            ["SGST @ 6%", inv.sgst.toFixed(2)],
            ["Total", inv.total_invoice_value.toFixed(2)]
          ]
        },
        margin: [0, 10]
      },
      { text: "*Please Deposit your Key to the Receptionists", italics: true, margin: [0, 15] },
      {
        columns: [
          { text: "Cashier Signature", alignment: "left" },
          { text: "Guest's Signature", alignment: "right" }
        ],
        margin: [0, 30]
      },
      { text: "THANK YOU FOR YOUR VISIT, PLEASE VISIT US AGAIN !!!!", alignment: "center", bold: true, margin: [0, 20] }
    ],
    styles: {
      header: { fontSize: 18, bold: true },
      hotelName: { fontSize: 16, bold: true }
    }
  };

  pdfMake.createPdf(dd).download(`${inv.invoice_number}.pdf`);
}
</script>

</body>
</html>
